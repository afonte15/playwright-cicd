name: Run Tagged Playwright Tests

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag to filter tests'
        required: true
        type: string
      playwright_repo:
        description: 'Playwright Automation Repository'
        required: true
        type: string
      playwright_repo_ref:
        description: 'Branch or commit to use in the Playwright repository'
        required: true
        type: string
        default: 'main'
      environment:
        description: 'Environment to run the tests against'
        required: false
        type: string
      run_command:
        description: 'Command to run the Playwright tests'
        required: false
        type: string
      base_url:
        description: 'Base URL for the environment'
        required: false
        type: string
      api_key:
        description: 'API key for the environment'
        required: true
        type: string
      username:
        description: 'Username for the environment'
        required: false
        type: string
      password:
        description: 'Password for the environment'
        required: false
        type: string
    secrets:
      REPO_GITHUB_TOKEN:
        required: false

jobs:
  run-tagged-playwright-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Playwright Automation Repo
      uses: actions/checkout@v3
      with:
        repository: ${{ inputs.playwright_repo }}
        ref: ${{ inputs.playwright_repo_ref }}
        token: ${{ secrets.REPO_GITHUB_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install Dependencies
      run: npm install

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Set Environment Variables
      run: |
        echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
        echo "BASE_URL=${{ inputs.base_url }}" >> $GITHUB_ENV
        echo "API_KEY=${{ inputs.api_key }}" >> $GITHUB_ENV
        echo "USERNAME=${{ inputs.username }}" >> $GITHUB_ENV
        echo "PASSWORD=${{ inputs.password }}" >> $GITHUB_ENV
    - name: Log Environment Variables
      run: |
        echo "Environment: $ENVIRONMENT"
        echo "Base URL: $BASE_URL"
        echo "API Key: $API_KEY"
        echo "Username: $USERNAME"
        echo "Password: $PASSWORD"

    - name: Run Playwright Tests with Tag
      run: TEST_ENV=${{ inputs.environment }} ${{ inputs.run_command }} --grep @${{ inputs.tag }}
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_GITHUB_TOKEN }}
